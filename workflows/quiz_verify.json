{
  "chain_id": "{{ENV.CHAIN_ID}}",
  "sender": "{{ENV.SENDER_ADDRESS}}",
  "delegate": "{{ENV.DELEGATE_ADDRESS}}",
  "attestor": "{{ENV.ATTESTOR_IMAGE}}",
  "sponsor_execution_fee": true,
  "value": "0",
  "intent": {
    "id": "{{TRANSACTION_INTENT_ID}}",
    "signature": "{{USER_SIGNATURE}}",
    "deadline": "{{TRANSACTION_INTENT_DEADLINE}}"
  },
  "rpc_url": "${_SECRETS.rpcSepoliaURL}",
  "target": {
    "contract": "${ENV.QUIZ_SCA_ADDRESS}",
    "function": "submitProofWithAuth((uint256,uint256,bytes32,(bytes32,bytes,bytes)[],bytes,bool,bytes))",
    "authData_result": "${encode-proof.result}",
    "parameters": []
  },
  "workflow": {
    "name": "quiz_verify",
    "version": "1.0.0",
    "steps": [
      {
        "name": "load-question",
        "type": "HTTP",
        "image": "${ENV.HTTP_EXECUTOR_IMAGE}",
        "attestor": "${ENV.ATTESTOR_IMAGE}",
        "next": "verify-answer",
        "config": {},
        "inputs": {
          "url": "${_SECRETS.supabaseRestUrl}/questions?id=eq.{{INPUT.questionId}}",
          "method": "GET",
          "headers": {
            "apikey": "${_SECRETS.supabaseServiceKey}",
            "Authorization": "Bearer ${_SECRETS.supabaseServiceKey}"
          }
        },
        "outputs": [
          {
            "name": "row",
            "value": "response.body.0",
            "export": true
          }
        ]
      },
      {
        "name": "verify-answer",
        "type": "HASH_COMPARE",
        "image": "${ENV.HASH_EXECUTOR_IMAGE}",
        "attestor": "${ENV.ATTESTOR_IMAGE}",
        "next": "compute-score",
        "config": {},
        "inputs": {
          "value": {
            "answer": "{{INPUT.answer}}",
            "correctHash": "${load-question.row.correct_hash}"
          }
        },
        "outputs": [
          {
            "name": "correct",
            "value": "result.correct",
            "export": true
          }
        ]
      },
      {
        "name": "compute-score",
        "type": "TRANSFORM",
        "image": "${ENV.TRANSFORM_EXECUTOR_IMAGE}",
        "attestor": "${ENV.ATTESTOR_IMAGE}",
        "next": "encode-proof",
        "config": {},
        "inputs": {
          "value": {
            "payload": {
              "sessionId": "{{INPUT.sessionId}}",
              "player": "{{INPUT.player}}",
              "questionId": "{{INPUT.questionId}}",
              "scoreDelta": "${verify-answer.correct}",
              "proofHash": "${load-question.row.correct_hash}"
            }
          }
        },
        "outputs": [
          {
            "name": "payload",
            "value": "result.payload",
            "export": true
          }
        ]
      },
      {
        "name": "encode-proof",
        "type": "EVM_ENCODER",
        "image": "${ENV.ENCODER_EXECUTOR_IMAGE}",
        "attestor": "${ENV.ATTESTOR_IMAGE}",
        "next": "store-submission",
        "config": {
          "parameters": [
            {
              "name": "payload",
              "type": "tuple",
              "components": [
                { "name": "sessionId", "type": "bytes32" },
                { "name": "player", "type": "address" },
                { "name": "questionId", "type": "bytes32" },
                { "name": "scoreDelta", "type": "uint256" },
                { "name": "proofHash", "type": "bytes32" }
              ]
            }
          ]
        },
        "inputs": {
          "value": {
            "payload": "${compute-score.payload}"
          }
        },
        "outputs": [
          {
            "name": "result",
            "value": "result",
            "export": true
          }
        ]
      },
      {
        "name": "store-submission",
        "type": "HTTP",
        "image": "${ENV.HTTP_EXECUTOR_IMAGE}",
        "attestor": "${ENV.ATTESTOR_IMAGE}",
        "config": {},
        "inputs": {
          "url": "${_SECRETS.supabaseRestUrl}/submissions",
          "method": "POST",
          "headers": {
            "Content-Type": "application/json",
            "apikey": "${_SECRETS.supabaseServiceKey}",
            "Authorization": "Bearer ${_SECRETS.supabaseServiceKey}"
          },
          "body": {
            "session_id": "{{INPUT.sessionId}}",
            "player_wallet": "{{INPUT.player}}",
            "question_id": "{{INPUT.questionId}}",
            "answer_choice": "{{INPUT.answer}}",
            "proof_hash": "${compute-score.payload.proofHash}"
          }
        },
        "outputs": [
          {
            "name": "stored",
            "value": "response.body",
            "export": true
          }
        ]
      }
    ]
  }
}
