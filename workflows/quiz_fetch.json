{
  "chain_id": "{{ENV.CHAIN_ID}}",
  "sender": "{{ENV.SENDER_ADDRESS}}",
  "delegate": "{{ENV.DELEGATE_ADDRESS}}",
  "attestor": "{{ENV.ATTESTOR_IMAGE}}",
  "sponsor_execution_fee": true,
  "value": "0",
  "intent": {
    "id": "{{TRANSACTION_INTENT_ID}}",
    "signature": "{{USER_SIGNATURE}}",
    "deadline": "{{TRANSACTION_INTENT_DEADLINE}}"
  },
  "rpc_url": "${_SECRETS.rpcSepoliaURL}",
  "workflow": {
    "name": "quiz_fetch",
    "version": "1.0.0",
    "steps": [
      {
        "name": "fetch-trivia",
        "type": "HTTP",
        "image": "${ENV.HTTP_EXECUTOR_IMAGE}",
        "attestor": "${ENV.ATTESTOR_IMAGE}",
        "next": "normalize-trivia",
        "config": {},
        "inputs": {
          "url": "https://opentdb.com/api.php?amount={{INPUT.count}}&category={{INPUT.category}}&difficulty={{INPUT.difficulty}}&type={{INPUT.type}}",
          "method": "GET"
        },
        "outputs": [
          {
            "name": "payload",
            "value": "response.body",
            "export": true
          }
        ]
      },
      {
        "name": "normalize-trivia",
        "type": "TRANSFORM",
        "image": "${ENV.TRANSFORM_EXECUTOR_IMAGE}",
        "attestor": "${ENV.ATTESTOR_IMAGE}",
        "next": "hash-answers",
        "config": {},
        "inputs": {
          "value": {
            "sessionId": "{{INPUT.sessionId}}",
            "raw": "${fetch-trivia.payload}"
          }
        },
        "outputs": [
          {
            "name": "questions",
            "value": "result.questions",
            "export": true
          },
          {
            "name": "hashed",
            "value": "result.hashed",
            "export": true
          }
        ]
      },
      {
        "name": "hash-answers",
        "type": "HASH",
        "image": "${ENV.HASH_EXECUTOR_IMAGE}",
        "attestor": "${ENV.ATTESTOR_IMAGE}",
        "next": "store-questions",
        "config": {},
        "inputs": {
          "value": "${normalize-trivia.hashed}"
        },
        "outputs": [
          {
            "name": "rows",
            "value": "result.rows",
            "export": true
          }
        ]
      },
      {
        "name": "store-questions",
        "type": "HTTP",
        "image": "${ENV.HTTP_EXECUTOR_IMAGE}",
        "attestor": "${ENV.ATTESTOR_IMAGE}",
        "config": {},
        "inputs": {
          "url": "${_SECRETS.supabaseRestUrl}/questions",
          "method": "POST",
          "headers": {
            "Content-Type": "application/json",
            "apikey": "${_SECRETS.supabaseServiceKey}",
            "Authorization": "Bearer ${_SECRETS.supabaseServiceKey}"
          },
          "body": "${hash-answers.rows}"
        },
        "outputs": [
          {
            "name": "stored",
            "value": "response.body",
            "export": true
          }
        ]
      }
    ]
  }
}
